# 1) Build stage
FROM node:18-alpine AS build
WORKDIR /app
COPY package*.json ./
RUN npm ci
COPY . .

# Accept build arguments for environment variables
ARG VITE_SUPABASE_URL
ARG VITE_SUPABASE_ANON_KEY
ARG VITE_AZURE_BLOB_SAS_TOKEN
ARG VITE_AZURE_BLOB_SAS_URL
ARG VITE_ZEGO_APP_ID
ARG VITE_ZEGO_SERVER_SECRET
ARG VITE_WEBSOCKET_URL
ARG VITE_API_BASE_URL
ARG VITE_AI_BACKEND_URL
ARG VITE_MESSAGE_WEBSOCKET_URL
ARG VITE_NOTIFICATION_WEBSOCKET_URL

# Set environment variables for the build
ENV VITE_SUPABASE_URL=$VITE_SUPABASE_URL
ENV VITE_SUPABASE_ANON_KEY=$VITE_SUPABASE_ANON_KEY
ENV VITE_AZURE_BLOB_SAS_TOKEN=$VITE_AZURE_BLOB_SAS_TOKEN
ENV VITE_AZURE_BLOB_SAS_URL=$VITE_AZURE_BLOB_SAS_URL
ENV VITE_ZEGO_APP_ID=$VITE_ZEGO_APP_ID
ENV VITE_ZEGO_SERVER_SECRET=$VITE_ZEGO_SERVER_SECRET
ENV VITE_WEBSOCKET_URL=$VITE_WEBSOCKET_URL
ENV VITE_API_BASE_URL=$VITE_API_BASE_URL
ENV VITE_AI_BACKEND_URL=$VITE_AI_BACKEND_URL
ENV VITE_MESSAGE_WEBSOCKET_URL=$VITE_MESSAGE_WEBSOCKET_URL
ENV VITE_NOTIFICATION_WEBSOCKET_URL=$VITE_NOTIFICATION_WEBSOCKET_URL

RUN npm run build

# 2) Serve stage
FROM nginx:1.25-alpine
# remove default site
RUN rm -rf /usr/share/nginx/html/*
# copy built files
COPY --from=build /app/dist /usr/share/nginx/html

# Copy custom nginx configuration
COPY nginx.conf /etc/nginx/conf.d/default.conf

EXPOSE 80
CMD ["nginx", "-g", "daemon off;"]
